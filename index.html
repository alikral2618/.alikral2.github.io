// MiniGram - Basit Firebase Sosyal Medya Uygulaması (React + Firebase)

// 1. Firebase Ayarları - firebase.js
import { initializeApp } from "firebase/app";
import { getAuth } from "firebase/auth";
import { getFirestore } from "firebase/firestore";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
export const auth = getAuth(app);
export const db = getFirestore(app);


// 2. Kullanıcı Girişi / Kayıt - Login.js
import { useState } from "react";
import { auth } from "./firebase";
import { signInWithEmailAndPassword, createUserWithEmailAndPassword } from "firebase/auth";

export default function Login() {
  const [email, setEmail] = useState("");
  const [pass, setPass] = useState("");
  const [isLogin, setIsLogin] = useState(true);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (isLogin) {
      await signInWithEmailAndPassword(auth, email, pass);
    } else {
      await createUserWithEmailAndPassword(auth, email, pass);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <input value={email} onChange={e => setEmail(e.target.value)} placeholder="Email" />
      <input type="password" value={pass} onChange={e => setPass(e.target.value)} placeholder="Password" />
      <button type="submit">{isLogin ? "Giriş Yap" : "Kayıt Ol"}</button>
      <p onClick={() => setIsLogin(!isLogin)} style={{ cursor: "pointer" }}>
        {isLogin ? "Kayıt ol" : "Zaten hesabın var mı?"}
      </p>
    </form>
  );
}


// 3. Gönderi Paylaşımı - PostForm.js
import { useState } from "react";
import { db } from "./firebase";
import { addDoc, collection, Timestamp } from "firebase/firestore";

export default function PostForm({ user }) {
  const [videoUrl, setVideoUrl] = useState("");
  const [desc, setDesc] = useState("");

  const submitPost = async (e) => {
    e.preventDefault();
    await addDoc(collection(db, "posts"), {
      user: user.email,
      videoUrl,
      desc,
      createdAt: Timestamp.now(),
      likes: [],
    });
    setVideoUrl("");
    setDesc("");
  };

  return (
    <form onSubmit={submitPost}>
      <input placeholder="Video URL" value={videoUrl} onChange={(e) => setVideoUrl(e.target.value)} />
      <input placeholder="Açıklama" value={desc} onChange={(e) => setDesc(e.target.value)} />
      <button type="submit">Paylaş</button>
    </form>
  );
}


// 4. Gönderi Listeleme ve Beğeni - PostList.js
import { useEffect, useState } from "react";
import { db } from "./firebase";
import { collection, onSnapshot, updateDoc, doc } from "firebase/firestore";

export default function PostList({ user }) {
  const [posts, setPosts] = useState([]);

  useEffect(() => {
    const unsub = onSnapshot(collection(db, "posts"), (snap) => {
      setPosts(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });
    return () => unsub();
  }, []);

  const likePost = async (id, likes) => {
    const postRef = doc(db, "posts", id);
    const newLikes = likes.includes(user.email)
      ? likes.filter(l => l !== user.email)
      : [...likes, user.email];
    await updateDoc(postRef, { likes: newLikes });
  };

  return posts.map(post => (
    <div key={post.id}>
      <h4>{post.user}</h4>
      <p>{post.desc}</p>
      <video width="300" controls src={post.videoUrl} />
      <button onClick={() => likePost(post.id, post.likes)}>
        {post.likes.includes(user.email) ? "Beğendin" : "Beğen"} ({post.likes.length})
      </button>
    </div>
  ));
}


// 5. Ana Uygulama - App.js
import { useEffect, useState } from "react";
import { auth } from "./firebase";
import { onAuthStateChanged } from "firebase/auth";
import Login from "./Login";
import PostForm from "./PostForm";
import PostList from "./PostList";

function App() {
  const [user, setUser] = useState(null);

  useEffect(() => {
    return onAuthStateChanged(auth, (user) => setUser(user));
  }, []);

  if (!user) return <Login />;
  return (
    <div>
      <h2>MiniGram</h2>
      <PostForm user={user} />
      <PostList user={user} />
    </div>
  );
}

export default App;
